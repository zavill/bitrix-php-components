var componentPath,floor,interphone,flat,entrance,user_index,user_comment,address,boolError,coords;window.VSCheckOutComponent=function(t){componentPath=t.componentPath,this.componentPath=t.componentPath,this.captchaActive=t.captcha,this.menu=t.Menu,this.backURL=t.backurl,"Y"==this.captchaActive&&(this.tryAttemptsMax=t.tryMax,this.tryAttempsCount=t.tryCount),this.authBlock=BX("auth_block_checkout"),this.captchaError=BX("captcha_error"),this.smsCodeBlock=BX("sms_code_block_checkout"),this.sendSmsButton=BX("get_code_button_checkout"),this.sendSMSInput=BX("phone_input_checkout"),this.codeInput=BX("code_sms_checkout"),this.tryAgainButton=BX("try_again_checkout"),this.captchaBlock=BX("g-recaptcha_checkout"),this.phoneText=BX("number_checkout"),this.fz152=BX("152fz_checkout"),this.timerTime=null,this.timeInterval=null,this.remainingTimeDOM=BX("timer_again_checkout"),this.secondsTimer=BX("seconds_timer_checkout"),this.timerOut=!1,this.mainInfoButton=BX("send_user_info"),this.mainInfoEMail=BX("user_email"),this.mainInfoName=BX("user_name"),this.mainInfoSurname=BX("user_surname"),this.checkoutSmallCard=BX("small_card_button_checkout"),this.changeAddressButton=BX("delivery_change_button"),this.submitCoupon=BX("coupon_button"),this.inputCoupon=BX("coupon_input"),this.discountBlock=BX("discount_block"),this.discountPrice=BX("sale_value"),this.totalPrice=BX("final_price"),this.couponBlock=BX("coupon_info"),this.couponName=BX("coupon_name"),this.couponDeleteButton=BX("delete_coupon_button"),this.priceBeforeSale=BX("price_value"),this.deliveryCommentInput=BX("delivery_comment"),this.discountsCount=t.DiscountsCount,this.AJAXrequest=t.AJAX,this.reloadTime=1e3*t.reloadTime,this.edit_address=!1,this.back_to_cart=BX("back_to_cart"),this.back_to_order=BX("back_to_order"),this.confirm_address_button=BX("address_button"),t.addressLine&&(address=t.addressLine),coords=t.coords_user,BX.ready(BX.delegate(this.init,this))},window.VSCheckOutComponent.prototype={init:function(){BX.showWait(),BX.bind(this.sendSmsButton,"click",BX.proxy(this.sendSmsCode,this)),BX.bind(this.codeInput,"input",BX.proxy(this.checkSMSCode,this)),BX.bind(this.tryAgainButton,"click",BX.proxy(this.showAuth,this)),BX.bind(this.mainInfoButton,"click",BX.proxy(this.sendMainInfo,this)),BX.bind(this.mainInfoEMail,"input",BX.proxy(this.checkEmail,this)),BX.bind(this.submitCoupon,"click",BX.proxy(this.CouponSet,this)),BX.bind(this.couponDeleteButton,"click",BX.proxy(this.CouponDelete,this)),BX.bind(this.changeAddressButton,"click",BX.proxy(this.editAddress,this)),BX.bind(this.confirm_address_button,"click",BX.proxy(function(){this.changeBackButtons(!1)},this)),BX.bind(this.confirmPointButton,"click",BX.proxy(function(){this.changeBackButtons(!1)},this)),BX.bind(this.back_to_order,"click",BX.proxy(function(){this.nextStep("checkout_block","user_adress"),this.changeBackButtons(!1)},this)),$("#phone_input_checkout").mask("+7 (999) 999 99 99",{autoclear:!1}),$("#phone_input_checkout").focus(),"Y"!=this.AJAXrequest&&ymaps.ready(this.initmap),this.mapActivated=!1,this.addressLine=BX("adress_input_line_wrap"),this.map=BX("ya_map"),this.showOnTheMapButton=BX("suggest_map"),this.confirmPointButton=BX("point_confirm_button"),this.datesArray={},BX.bind(this.showOnTheMapButton,"click",BX.proxy(this.showMapMobile,this)),$(".delivery_dates_select").select2({minimumResultsForSearch:-1}),BX.bind(this.checkoutSmallCard,"click",BX.proxy(this.checkOut,this)),$("#small_card_button_checkout").prop("disabled",!1),BX.closeWait()},initmap:function(){var t,e;new ymaps.SuggestView("suggest").events.add("select",function(t){n()});var o=ymaps.geolocation;function s(t){ymaps.geocode(t).then(function(e){var o=e.geoObjects.get(0);$("#suggest").removeClass("input_error"),$("#notice").css("display","none"),$("#suggest").val(o.getAddressLine()),address=o.getAddressLine(),coords=t[0]+", "+t[1],boolError=!1})}function n(){var o=$("#suggest").val();ymaps.geocode(o).then(function(o){var s,n,i,a=o.geoObjects.get(0);if(boolError=!0,a)switch(a.properties.get("metaDataProperty.GeocoderMetaData.precision")){case"exact":break;case"number":case"near":case"range":s="Неточный адрес, требуется уточнение",n="Уточните номер дома";break;case"street":s="Неполный адрес, требуется уточнение",n="Уточните номер дома";break;case"other":default:s="Неточный адрес, требуется уточнение",n="Уточните адрес"}else s="Адрес не найден",n="Уточните адрес";s?(i=s,$("#notice").text(i),$("#suggest").addClass("input_error"),$("#notice").css("display","block"),showMessage(n)):(!function(o){$("#suggest").removeClass("input_error"),$("#notice").css("display","none");var s=$("#ya_map"),n=o.properties.get("boundedBy");mapState=ymaps.util.bounds.getCenterAndZoom(n,[s.width(),s.height()]),address=o.getAddressLine(),mapState.controls=[],i=mapState,t.panTo(i.center),e.geometry.setCoordinates(i.center),coords="";var i}(a),boolError=!1)},function(t){console.log(t)})}function i(){console.log(address),boolError||(floor=$("#floor").val(),user_index=$("#postcode").val(),entrance=$("#entrance").val(),flat=$("#apartament").val(),interphone=$("#doorphone").val(),user_comment=$("#delivery_com").val(),BX.ajax({url:componentPath+"/ajax.php"+(-1!==document.location.href.indexOf("clear_cache=Y")?"?clear_cache=Y":""),method:"POST",dataType:"json",timeout:60,data:{set_address:1,street:address,floor:floor,user_index:user_index,entrance:entrance,flat:flat,interphone:interphone,user_comment:user_comment,coords:coords},onsuccess:BX.delegate(function(t){"Okay"==t.RESULT&&window.VSCheckOutComponent.prototype.goToCheckout()},this)}))}o.get({mapStateAutoApply:!0}).then(function(o){var i=o.geoObjects.get(0).geometry.getCoordinates();t=new ymaps.Map("ya_map",{center:i,zoom:11,controls:["zoomControl"]},{suppressMapOpenBlock:!0},{preset:"islands#redDotIconWithCaption"}),e=new ymaps.Placemark(i,{},{draggable:!0,preset:"islands#redDotIcon",iconLayout:"default#image",iconImageHref:componentPath+"/images/Group_12.svg",iconImageSize:[76,112],iconImageOffset:[-38,-112]}),t.geoObjects.add(e),t.events.add("click",function(t){var o=t.get("coords");e.geometry.setCoordinates(o),s(o)}),e.events.add("dragend",function(t){s(e.geometry.getCoordinates())}),""!=$("#suggest").val()?(""!=coords&&((coords=coords.split(", "))[0]=parseFloat(coords[0]),coords[1]=parseFloat(coords[1]),e.geometry.setCoordinates(coords)),n()):s(e.geometry.getCoordinates());var a=new ymaps.control.GeolocationControl({options:{noPlacemark:!0}});a.events.add("locationchange",function(o){var n=o.get("position");e.geometry.setCoordinates(n),t.panTo(n),s(n)}),t.controls.add(a)}),o.get({provider:"browser",mapStateAutoApply:!0}).then(function(o){""==$("#suggest").val()&&(e.geometry.setCoordinates(o.geoObjects.position),s(e.geometry.getCoordinates()),t.panTo(e.geometry.getCoordinates()))}),$("#address_button").bind("click",function(t){i()}),$("#point_confirm_button").bind("click",function(t){i()})},goToCheckout:function(){this.edit_address&&(this.edit_address=!1),this.updateCheckout()},CouponSet:function(){if(""==this.inputCoupon.value)return BX.addClass(this.inputCoupon,"error_input"),1;BX.removeClass(this.inputCoupon,"error_input"),BX.ajax({url:componentPath+"/ajax.php"+(-1!==document.location.href.indexOf("clear_cache=Y")?"?clear_cache=Y":""),method:"POST",dataType:"json",timeout:60,data:{discount_update:1,coupon:this.inputCoupon.value},onsuccess:BX.delegate(function(t){console.log(t),1==t.SUCCESS&&t.SALE_PRICE>0?(this.recalculateTotal(t),this.discountsCount++):BX.addClass(this.inputCoupon,"error_input")},this)})},CouponDelete:function(){this.discountsCount<=1?this.hideCoupons():BX.showWait(),BX.ajax({url:componentPath+"/ajax.php"+(-1!==document.location.href.indexOf("clear_cache=Y")?"?clear_cache=Y":""),method:"POST",dataType:"json",timeout:60,data:{discount_update:1,coupon:"destroy"},onsuccess:BX.delegate(function(t){console.log(t),1==t.SUCCESS&&(this.totalPrice.innerHTML=t.PRICE,this.discountsCount--,BX.closeWait())},this)})},recalculateTotal:function(t){this.discountPrice.innerHTML=t.SALE,this.totalPrice.innerHTML=t.PRICE,BX.style(this.discountBlock,"display",""),t.NAME?(this.couponName.innerText=t.NAME,BX.style(this.couponBlock,"display","")):BX.style(this.couponBlock,"display","none"),BX.closeWait()},hideCoupons:function(){this.inputCoupon.value="",BX.style(this.discountBlock,"display","none"),BX.style(this.couponBlock,"display","none")},updateCheckout:function(){BX.showWait(),BX.ajax.post(componentPath+"/ajax.php",{updateCheckout:1},function(t){$("#checkout_block").html($(t).find("#checkout_block").html()),$(document).unbind("click.fb-start"),$("#login-link").html($(t).find("#login-link").html()),window.VSCheckOutComponent.prototype.nextStep("checkout_block","phone_auth"),window.VSCheckOutComponent.prototype.nextStep("checkout_block","user_adress"),BX.closeWait()})},editAddress:function(){this.edit_address=!0,this.nextStep("user_adress","checkout_block"),this.changeBackButtons(!0)},changeBackButtons:function(t){t?(BX.hide(this.back_to_cart),BX.show(this.back_to_order)):(BX.show(this.back_to_cart),BX.hide(this.back_to_order))},sendSmsCode:function(){if(-1!=this.sendSMSInput.value.indexOf("_")||""==this.sendSMSInput.value)return BX.addClass(this.sendSMSInput,"error_input"),1;if(BX.removeClass(this.sendSMSInput,"error_input"),this.captcha=grecaptcha.getResponse(),this.tryAttempsCount>=this.tryAttemptsMax&&"Y"==this.captchaActive){if(!this.captcha.length)return void BX.style(this.captchaError,"display","");BX.style(this.captchaError,"display","none;")}BX.ajax({url:this.componentPath+"/ajax.php"+(-1!==document.location.href.indexOf("clear_cache=Y")?"?clear_cache=Y":""),method:"POST",dataType:"json",timeout:60,data:{phone:this.sendSMSInput.value,CHECK_SMS:0,recaptcha:this.captcha},onsuccess:BX.delegate(function(t){console.log(t),BX.style(this.fz152,"display",""),t&&"Authorized"==t.TEXT?this.authorizeCheck(t):(t&&"Authorization"==t.TEXT&&BX.style(this.fz152,"display","none"),this.showSmsCode())},this)}),this.startTimer(),this.tryAttempsCount++,grecaptcha.reset()},getDeliveryDates:function(){this.datesArray={};let t=this;$(".delivery_dates_select").each(function(){console.log(t.datesArray),t.datesArray[$(this).data("id")]=$(this).val()})},checkOut:function(){""!=address&&(floor=$("#floor").val(),user_index=$("#postcode").val(),entrance=$("#entrance").val(),flat=$("#apartament").val(),interphone=$("#doorphone").val(),user_comment=$("#delivery_comment").val(),""!=floor&&(floor="этаж "+floor),""!=entrance&&(entrance="подъезд "+entrance),""!=flat&&(flat="кв./оф. "+flat),""!=interphone&&(interphone="домофон "+interphone),this.getDeliveryDates(),BX.showWait(),BX.ajax({url:this.componentPath+"/ajax.php"+(-1!==document.location.href.indexOf("clear_cache=Y")?"?clear_cache=Y":""),method:"POST",dataType:"json",timeout:60,data:{create_order:1,address:address,floor:floor,user_index:user_index,entrance:entrance,flat:flat,interphone:interphone,user_comment:user_comment,coords:coords,delivery:2,paysystem:4,datesArray:JSON.stringify(this.datesArray)},onsuccess:BX.delegate(function(t){t.ID>0?(console.log(t),""!==t.URL_TO_PAY?location.href=t.URL_TO_PAY:location.href="/order_done/?number="+orderId,ym(49157746,"reachGoal","ORDER"),BX.closeWait()):console.log(t)},this)}))},startTimer:function(){this.secondsTimer.innerHTML=this.reloadTime/1e3,this.timerTime=new Date(Date.parse(new Date)+this.reloadTime),this.timerOut=!0,BX.style(this.remainingTimeDOM,"display",""),BX.style(this.tryAgainButton,"display","none"),this.timeInterval=setInterval(this.timerSMS,1e3,this.secondsTimer,this.timerTime),setTimeout(()=>{clearInterval(this.timeInterval),BX.style(this.remainingTimeDOM,"display","none"),BX.style(this.tryAgainButton,"display",""),this.timerOut=!1},this.reloadTime)},checkSMSCode:function(){if(4!=this.codeInput.value.length)return 1;BX.ajax({url:this.componentPath+"/ajax.php"+(-1!==document.location.href.indexOf("clear_cache=Y")?"?clear_cache=Y":""),method:"POST",dataType:"json",timeout:60,data:{phone:this.sendSMSInput.value,code:this.codeInput.value,CHECK_SMS:1},onsuccess:BX.delegate(function(t){console.log(t),t&&"INVALID CODE"==t.TEXT?this.createError(this.codeInput):t&&"Authorized"==t.TEXT&&this.authorizeCheck(t)},this)})},timerSMS:function(t,e){this.t=Date.parse(e)-Date.parse(new Date),this.seconds=Math.floor(this.t/1e3%60),t.innerHTML=this.seconds},showSmsCode:function(){this.phoneText.innerText=this.sendSMSInput.value,BX.style(this.authBlock,"display","none"),BX.style(this.smsCodeBlock,"display",""),$("#code_sms_checkout").focus()},authorizeCheck:function(t){console.log(t),this.user_adress=t.PERSONAL_STREET,this.user_name=t.NAME,this.user_last_name=t.LAST_NAME,this.user_email=t.EMAIL,$("#suggest").val(this.user_adress),$("#user_email").val(this.user_email),$("#user_name").val(this.user_name),$("#user_surname").val(this.user_last_name),null==t.NAME||null==t.LAST_NAME||null==t.EMAIL?this.nextStep("main_data_user","phone_auth"):null==t.PERSONAL_STREET||""==t.PERSONAL_STREET?this.nextStep("user_adress","phone_auth"):this.updateCheckout()},showAuth:function(){1!=this.timerOut&&(this.tryAttempsCount>=this.tryAttemptsMax&&"Y"==this.captchaActive&&BX.style(this.captchaBlock,"display",""),console.log(this.tryAttempsCount+" : "+this.tryAttemptsMax+" : "+this.captchaActive),BX.style(this.authBlock,"display",""),BX.style(this.smsCodeBlock,"display","none"))},createError:function(t){BX.addClass(t,"error_input"),BX.bind(t,"input",BX.proxy(this.codeError.bind(this,t),this))},codeError:function(t){BX.removeClass(t,"error_input")},sendMainInfo:function(){this.checkOutMainInfo(),this.inputErrors||(""!=$("#suggest").val()?this.nextStep("checkout_block","main_data_user"):this.nextStep("user_adress","main_data_user"),BX.ajax({url:this.componentPath+"/ajax.php"+(-1!==document.location.href.indexOf("clear_cache=Y")?"?clear_cache=Y":""),method:"POST",dataType:"json",timeout:60,data:{email:this.mainInfoEMail.value,name:this.mainInfoName.value,surname:this.mainInfoSurname.value,updateUser:1},onsuccess:BX.delegate(function(t){},this)}))},emailValidation:function(t){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(t)},checkEmail:function(){this.emailValidation(this.mainInfoEMail.value)?(BX.removeClass(this.mainInfoEMail,"error_input"),this.inputErrors=!1):(BX.addClass(this.mainInfoEMail,"error_input"),this.inputErrors=!0)},checkOutMainInfo:function(){this.inputErrors=!1,this.checkEmail(),""==this.mainInfoEMail.value&&(this.inputErrors=!0),""==this.mainInfoName.value&&(this.createError(this.mainInfoName),this.inputErrors=!0),""==this.mainInfoSurname.value&&(this.createError(this.mainInfoSurname),this.inputErrors=!0)},nextStep:function(t,e){switch("checkout_block"==t||"user_adress"==t?BX.style(BX(t),"display","flex"):BX.show(BX(t)),BX.hide(BX(e)),t){case"user_adress":this.edit_address||(BX.addClass(BX("step_address"),"actual"),BX.removeClass(BX("step_authorize"),"actual"),BX.addClass(BX("step_authorize"),"completed"));break;case"checkout_block":BX.hide(BX("steps_wrap"))}},showMapMobile:function(){this.mapActivated?(this.mapActivated=!1,BX.show(this.addressLine),BX.hide(this.confirmPointButton),BX.hide(this.map),this.showOnTheMapButton.innerText="Выбрать на карте"):(this.mapActivated=!0,BX.hide(this.addressLine),BX.show(this.confirmPointButton),BX.show(this.map),this.showOnTheMapButton.innerText="Закрыть карту")}};